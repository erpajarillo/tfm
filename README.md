# Calculate Vehicle CO2 emission using remote image data

## Description
This project contains source code and supporting files of my TFM in Advanced Analytics on Big Data. 

Consists in scrape images from Malaga traffic cameras to detect the vehicles in each image and calculate the estimated
CO2 expelled by the vehicles.
The project use services as containers communicated by events (Kafka) and store the data in No SQL Database (MongoDB).
The final result can be checked in a webpage built with Vue.js.

### Folder Structure

It includes the following files and folders.

- `img-scrapper` Service to scrape images from Malaga traffic cameras
- `vehicle-detector` Service to detect vehicles types and vehicles amount in images scrapped in the previous app
- `pollution-calculator` Service to calculate (roughly) the CO2 expelled by the vehicles
- `info-store` Service to store all the data generated by the applications in MongoDB
- `webpage` Parent folder of the webpage
- `webpage/backend` Backend webpage to query data from MongoDB
- `webpage/frontend` Frontend webpage to show data retrieved in the backend
- `docker-compose-example.yml` File to create a network of containers with the services previously described plus 
  Kafka & Zookeeper to communicate all the containers. Necessary to rename to `docker-compose.yml`
  
The application uses AWS S3 bucket, and a MongoDB cluster. 
These resources should be defined in the file `docker-compose.yml` filling the environment variables:
- `AWSAccessKey` and `AWS_ACCESS_KEY_ID` with AWS Access Key of a user with access to S3
- `AWSSecretKey` and `AWS_SECRET_ACCESS_KEY` with AWS Secret Key of a user with access to S3
- `MongoConnection` with `mongodb+srv://{user}:{pass}@{cluster.mongodb.net}`

The languages used are `Javascript`, `Node`, `TypeScript`, `Python` and `Vue`.

## Deploy the TFM

### Prerequisites

- Install Docker (https://docs.docker.com/engine/install/)
- Create an AWS user with access to S3 (https://aws.amazon.com/es/)
- Create a MongoDB cluster (ex: https://www.mongodb.com/cloud/atlas)

### Steps

1. Execute in each service folder the commands:
```bash
npm install
npm run compile
```
2. Execute in each service folder:
```bash
docker build . -t erpajarillo/{folder-name}:latest
```
3. Fill the environment variables `AWSAccessKey`, `AWS_ACCESS_KEY_ID`, `AWSSecretKey`, `AWS_SECRET_ACCESS_KEY` 
   and `MongoConnection` in `docker-compose.yml`
4. Create a S3 bucket called `images-tfm`
5. In the folder of the file `docker-compose.yml` executes:
```bash
docker-compose up -d
```

The first step is necessary to compile TypeScript to JavaScript due to we are going to use the JavaScript files in
Docker. The second step will create the image of the folder dist with the Javascript files. The third and fourth steps
are to configure AWS. The fifth step is to build all the Docker network with all the containers.

## Test locally

Build the network with the `docker-compose up -d` command.

```bash
docker-compose up -d
```

Check the logs of each container to see the executions, and the final result can be checked in the frontend 
(http://localhost:5000)

It is possible to execute the containers separately with the only requirement that Kafka needs to be running.

## Add a container to the application

It is possible to add more containers (services) to the application in the `docker-compose.yml` or outside Docker since
Kafka is listening in the local port `9092`.

## Service Logs

All the services are sending logs to console in each action they are performing. It is possible to add an external log
application to send there all the logs.

## Unit tests

Tests are defined in the `/tests` folder of each service.
Use [Jest test framework](https://jestjs.io/) and run unit tests from your local machine.

```bash
npm run test
```

## Cleanup

To delete the application run the following commands:

```bash
docker stop <container-id>
docker rm <container-id>
docker rmi <image-id>
```

## Resources

See the 
[keras-yolo3](https://github.com/qqwweee/keras-yolo3) project, 
[Kafka Bitnami](https://hub.docker.com/r/bitnami/kafka/) image,
[Zookeeper](https://hub.docker.com/r/bitnami/zookeeper) image and
[Docker Compose](https://docs.docker.com/compose/) info
used for this project
